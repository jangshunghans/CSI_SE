<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê±´ì„¤ì•ˆì „</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: "Malgun Gothic", "Apple SD Gothic Neo", sans-serif; margin: 0; padding: 12px; background: #f5f5f5; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; }

    /* ê²€ìƒ‰ ì˜ì—­ */
    .search-panel { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); padding: 10px 14px 12px; margin-bottom: 8px; }
    .problem-keyword-row { display: flex; align-items: flex-end; gap: 8px; grid-column: 1 / -1; flex-wrap: wrap; }
    .problem-keyword-row .field { min-width: 0; }
    .problem-keyword-row .field-problem { flex: 0 1 200px; }
    .problem-keyword-row .field-keyword { flex: 1; min-width: 160px; }
    .btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 4px; }
    .btn-sm { padding: 6px 10px; font-size: 12px; }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #fff; color: #374151; border: 1px solid #d1d5db; }
    .btn-secondary:hover { background: #f9fafb; }
    .search-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px 10px; align-items: end; }
    .field { display: flex; flex-direction: column; gap: 2px; }
    .field label { font-size: 12px; color: #4b5563; }
    .field select, .field input { padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; }
    .field-problem input { font-size: 12px; padding: 5px 6px; max-width: 100%; }
    .field input::placeholder { color: #9ca3af; }
    .field.session-range { display: flex; flex-direction: column; gap: 2px; }
    .field.session-range .range-wrap { display: flex; align-items: center; gap: 6px; }
    .field.session-range .range-wrap input { width: 72px; text-align: center; }
    .date-session-row { display: flex; align-items: flex-end; gap: 10px; flex-wrap: nowrap; grid-column: 1 / -1; }
    .date-session-row .field { flex: 0 0 auto; min-width: 0; }
    .usage-with-actions { display: flex; align-items: flex-end; gap: 8px; }
    .usage-with-actions .field { flex: 0 0 auto; }
    .usage-with-actions .search-actions-inline { display: flex; gap: 6px; align-items: center; flex-shrink: 0; }
    .result-count { font-size: 13px; color: #4b5563; }
    .result-count strong { color: #111; }

    /* ì¡°íšŒ ê²°ê³¼ */
    .result-panel { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); padding: 12px 16px; overflow: auto; }
    .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 8px; }
    .result-actions { display: flex; gap: 8px; }
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border: 1px solid #9ca3af; padding: 14px 16px; text-align: left; vertical-align: top; }
    th { background: #f3f4f6; font-weight: 600; color: #374151; white-space: nowrap; border-bottom: 2px solid #6b7280; text-align: center; }
    td { border-bottom: 1px solid #9ca3af; }
    tr:hover { background: #f9fafb; }
    .col-no { width: 52px; min-width: 52px; text-align: center; border-right: 2px solid #6b7280 !important; }
    .col-major { min-width: 200px; border-right: 2px solid #6b7280 !important; }
    table th:first-child { border-right: 2px solid #6b7280 !important; }
    table th:nth-child(2) { border-right: 2px solid #6b7280 !important; }
    .col-detail { min-width: 220px; }
    .col-problem { min-width: 260px; text-align: left; }
    table td:nth-child(3), table th:nth-child(3) { text-align: left; }
    .col-num { white-space: nowrap; }
    .col-num a { color: #2563eb; text-decoration: none; }
    .col-num a:hover { text-decoration: underline; }
    .col-keyword { min-width: 180px; }
    .col-use { width: 60px; text-align: center; }

    .loading { text-align: center; padding: 40px; color: #6b7280; }
    .error { background: #fef2f2; color: #b91c1c; padding: 12px; border-radius: 6px; margin-bottom: 16px; }
  </style>
</head>
<body>
  <div class="container">
    <section class="search-panel">
      <div class="search-grid">
        <div class="field">
          <label>ì£¼ìš”í•­ëª©</label>
          <select id="majorItem">
            <option value="">ì „ì²´</option>
          </select>
        </div>
        <div class="field">
          <label>ì„¸ë¶€í•­ëª©</label>
          <select id="subItem">
            <option value="">ì „ì²´</option>
          </select>
        </div>
        <div class="usage-with-actions">
          <div class="field">
            <label>ì‚¬ìš©ì—¬ë¶€</label>
            <select id="usage">
              <option value="">ì „ì²´</option>
            </select>
          </div>
          <div class="search-actions-inline">
            <button type="button" class="btn btn-sm btn-primary" id="btnSearch">ğŸ” ê²€ìƒ‰</button>
            <button type="button" class="btn btn-sm btn-secondary" id="btnReset">ğŸ”„ ì´ˆê¸°í™”</button>
          </div>
        </div>
        <div class="problem-keyword-row">
          <div class="field field-problem">
            <label>ë¬¸ì œ</label>
            <input type="text" id="problem" placeholder="ë¬¸ì œ ê²€ìƒ‰" />
          </div>
          <div class="field field-keyword">
            <label>í•µì‹¬í‚¤ì›Œë“œ</label>
            <input type="text" id="coreKeyword" placeholder="í‚¤ì›Œë“œ (ì˜ˆ: ê°ì „, ì¶”ë½)" />
          </div>
        </div>
        <div class="date-session-row">
          <div class="field">
            <label>ì¶œì œë…„</label>
            <select id="pubYear">
              <option value="">ì „ì²´</option>
            </select>
          </div>
          <div class="field">
            <label>ì¶œì œì›”</label>
            <select id="pubMonth">
              <option value="">ì „ì²´</option>
            </select>
          </div>
          <div class="field session-range">
            <label>íšŒì°¨</label>
            <div class="range-wrap">
              <input type="text" id="sessionFrom" placeholder="FROM" inputmode="numeric" pattern="[0-9]*" maxlength="6" />
              <span>~</span>
              <input type="text" id="sessionTo" placeholder="TO" inputmode="numeric" pattern="[0-9]*" maxlength="6" />
            </div>
          </div>
          <div class="field">
            <label>êµì‹œ</label>
            <select id="period">
              <option value="">ì „ì²´</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- ì¡°íšŒ ê²°ê³¼ -->
    <section class="result-panel">
      <div class="result-header">
        <div class="result-count">
          ê²€ìƒ‰ ê²°ê³¼: <strong id="filterCount">0</strong>ê±´ / ì „ì²´: <strong id="totalCount">0</strong>ê±´
        </div>
        <div class="result-actions">
          <button type="button" class="btn btn-secondary" id="btnOpenAll">ëª¨ë‘ ì—´ê¸°</button>
          <button type="button" class="btn btn-secondary" id="btnDownloadAll">ì „ì²´ ë‹¤ìš´ë¡œë“œ</button>
          <button type="button" class="btn btn-secondary" id="btnDownloadFiltered">ê²€ìƒ‰ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
        </div>
      </div>
      <div id="resultArea">
        <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      </div>
    </section>
  </div>

  <script>
    (function () {
      const FIELDS = ['No', 'ì¶œì œë…„', 'ì¶œì œì›”', 'íšŒì°¨', 'êµì‹œ', 'ë¬¸í•­', 'ë¬¸í•­ë²ˆí˜¸', 'ë¬¸ì œ', 'ì£¼ìš”í•­ëª©', 'ì„¸ë¶€í•­ëª©', 'ë¬¸ì œì˜ í•µì‹¬ í‚¤ì›Œë“œ', 'ì‚¬ìš©ì—¬ë¶€'];
      let allData = [];
      let filteredData = [];

      function getOption(dataUrl) {
        return fetch(dataUrl)
          .then(r => { if (!r.ok) throw new Error(r.statusText); return r.json(); })
          .catch(() => fetch('csi.json').then(r => r.json()));
      }

      function loadData() {
        const dataUrl = '/api/csi';
        getOption(dataUrl)
          .then(data => {
            allData = Array.isArray(data) ? data : [];
            filteredData = [...allData];
            fillSelects();
            setSessionRangeDefaults();
            renderTable(filteredData);
            updateCounts();
          })
          .catch(e => {
            document.getElementById('resultArea').innerHTML =
              '<div class="error">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (csi.json ë˜ëŠ” /api/csi í•„ìš”)</div>';
            console.error(e);
          });
      }

      const uniq = (arr, key) => [...new Set(arr.map(x => x[key]).filter(Boolean))].sort((a, b) => (a < b ? -1 : 1));
      const sel = (id, values, first = 'ì „ì²´') => {
        const el = document.getElementById(id);
        if (!el) return;
        const current = el.value;
        el.innerHTML = '<option value="">' + first + '</option>';
        values.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          el.appendChild(opt);
        });
        if (values.includes(current)) el.value = current;
      };

      function updateSubItems(selectedMajor) {
        const base = selectedMajor ? allData.filter(x => x['ì£¼ìš”í•­ëª©'] === selectedMajor) : allData;
        sel('subItem', uniq(base, 'ì„¸ë¶€í•­ëª©'));
      }

      function fillSelects() {
        sel('majorItem', uniq(allData, 'ì£¼ìš”í•­ëª©'));
        updateSubItems('');
        sel('pubYear', uniq(allData, 'ì¶œì œë…„').map(String));
        sel('pubMonth', uniq(allData, 'ì¶œì œì›”').map(String));
        sel('period', uniq(allData, 'êµì‹œ').map(String));
        sel('usage', uniq(allData, 'ì‚¬ìš©ì—¬ë¶€'));
      }

      function setSessionRangeDefaults() {
        const sessions = allData.map(r => r['íšŒì°¨']).filter(v => v != null && v !== '');
        const nums = sessions.map(v => Number(v)).filter(v => !isNaN(v));
        if (nums.length) {
          document.getElementById('sessionFrom').value = Math.min(...nums);
          document.getElementById('sessionTo').value = Math.max(...nums);
        }
      }

      function filterData() {
        const major = document.getElementById('majorItem').value;
        const sub = document.getElementById('subItem').value;
        const problem = document.getElementById('problem').value.trim().toLowerCase();
        const keyword = document.getElementById('coreKeyword').value.trim().toLowerCase();
        const year = document.getElementById('pubYear').value;
        const month = document.getElementById('pubMonth').value;
        const fromVal = document.getElementById('sessionFrom').value.trim();
        const toVal = document.getElementById('sessionTo').value.trim();
        const from = fromVal !== '' && !isNaN(Number(fromVal)) ? Number(fromVal) : null;
        const to = toVal !== '' && !isNaN(Number(toVal)) ? Number(toVal) : null;
        const period = document.getElementById('period').value;
        const usage = document.getElementById('usage').value;

        filteredData = allData.filter(row => {
          if (major && row['ì£¼ìš”í•­ëª©'] !== major) return false;
          if (sub && row['ì„¸ë¶€í•­ëª©'] !== sub) return false;
          if (problem && !String(row['ë¬¸ì œ'] || '').toLowerCase().includes(problem)) return false;
          if (keyword) {
            const kw = String(row['ë¬¸ì œì˜ í•µì‹¬ í‚¤ì›Œë“œ'] || '').toLowerCase();
            const terms = keyword.split(/[\s,]+/).filter(Boolean);
            if (!terms.every(t => kw.includes(t))) return false;
          }
          if (year && String(row['ì¶œì œë…„']) !== year) return false;
          if (month && String(row['ì¶œì œì›”']) !== month) return false;
          const session = row['íšŒì°¨'];
          if (from != null && (session == null || session < from)) return false;
          if (to != null && (session == null || session > to)) return false;
          if (period && String(row['êµì‹œ']) !== period) return false;
          if (usage && row['ì‚¬ìš©ì—¬ë¶€'] !== usage) return false;
          return true;
        });
        renderTable(filteredData);
        updateCounts();
      }

      function renderTable(rows) {
        const area = document.getElementById('resultArea');
        if (!rows.length) {
          area.innerHTML = '<div class="loading">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        const headers = ['No', 'ì£¼ìš”í•­ëª©', 'ì„¸ë¶€í•­ëª©', 'ë¬¸ì œ', 'ë¬¸í•­ë²ˆí˜¸', 'ë¬¸ì œì˜ í•µì‹¬ í‚¤ì›Œë“œ', 'ì‚¬ìš©'];
        let html = '<div class="table-wrap"><table><thead><tr>';
        headers.forEach(h => { html += '<th>' + h + '</th>'; });
        html += '</tr></thead><tbody>';
        rows.forEach(r => {
          const no = r['No'] != null ? String(r['No']) : '';
          const major = r['ì£¼ìš”í•­ëª©'] != null ? String(r['ì£¼ìš”í•­ëª©']) : '';
          html += '<tr>';
          html += '<td class="col-no">' + escapeHtml(no) + '</td>';
          html += '<td class="col-major">' + escapeHtml(major) + '</td>';
          html += '<td class="col-detail">' + escapeHtml(r['ì„¸ë¶€í•­ëª©']) + '</td>';
          html += '<td class="col-problem">' + escapeHtml(r['ë¬¸ì œ']) + '</td>';
          const num = r['ë¬¸í•­ë²ˆí˜¸'];
          const numStr = num != null ? String(num) : '';
          const numLink = numStr ? '<a href="http_load/' + escapeHtml(numStr) + '.html" target="_blank" rel="noopener">' + escapeHtml(numStr) + '</a>' : '';
          html += '<td class="col-num">' + numLink + '</td>';
          html += '<td class="col-keyword">' + escapeHtml(r['ë¬¸ì œì˜ í•µì‹¬ í‚¤ì›Œë“œ']) + '</td>';
          html += '<td class="col-use">' + escapeHtml(r['ì‚¬ìš©ì—¬ë¶€']) + '</td>';
          html += '</tr>';
        });
        html += '</tbody></table></div>';
        area.innerHTML = html;
      }

      function escapeHtml(s) {
        if (s == null) return '';
        const t = document.createElement('span');
        t.textContent = s;
        return t.innerHTML;
      }

      function updateCounts() {
        const totalEl = document.getElementById('totalCount');
        const filterEl = document.getElementById('filterCount');
        if (totalEl) totalEl.textContent = allData.length;
        if (filterEl) filterEl.textContent = filteredData.length;
      }

      function toCsv(rows) {
        const headers = ['No', 'ì£¼ìš”í•­ëª©', 'ì„¸ë¶€í•­ëª©', 'ë¬¸ì œ', 'ë¬¸í•­ë²ˆí˜¸', 'ë¬¸ì œì˜ í•µì‹¬ í‚¤ì›Œë“œ', 'ì‚¬ìš©ì—¬ë¶€'];
        const line = arr => arr.map(v => '"' + String(v == null ? '' : v).replace(/"/g, '""') + '"').join(',');
        return '\uFEFF' + line(headers) + '\n' + rows.map(r => line(headers.map(h => r[h]))).join('\n');
      }

      function downloadCsv(rows, filename) {
        const blob = new Blob([toCsv(rows)], { type: 'text/csv;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename || 'csi.csv';
        a.click();
        URL.revokeObjectURL(a.href);
      }

      function openFilteredInWindows() {
        const rows = filteredData;
        if (!rows.length) {
          alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì¡°ê±´ì„ ì…ë ¥í•œ ë’¤ ê²€ìƒ‰ í›„ ì´ìš©í•˜ì„¸ìš”.');
          return;
        }
        const pathDir = location.pathname.replace(/\/[^/]*$/, '') || '';
        const base = location.origin + pathDir + (pathDir ? '/' : '/');
        const items = [];
        rows.forEach(function (r) {
          const num = r['ë¬¸í•­ë²ˆí˜¸'];
          const numStr = num != null ? String(num).trim() : '';
          if (numStr) items.push({ url: base + 'http_load/' + encodeURIComponent(numStr) + '.html', numStr: numStr });
        });
        if (!items.length) {
          alert('ì—´ ìˆ˜ ìˆëŠ” ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        function showNoDataPage(numStr) {
          const html = '<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>ìë£Œ ì—†ìŒ</title><style>body{font-family:\'Malgun Gothic\',sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;background:#f5f5f5;} .box{text-align:center;padding:2rem;background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);} h1{color:#666;font-size:1.5rem;margin:0 0 0.5rem;} p{color:#999;margin:0;}</style></head><body><div class="box"><h1>ìë£Œ ì—†ìŒ</h1><p>ë¬¸í•­ ' + (numStr || '-') + ' ì— í•´ë‹¹í•˜ëŠ” ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p></div></body></html>';
          const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
          const blobUrl = URL.createObjectURL(blob);
          const w = window.open(blobUrl, '_blank', 'noopener');
          if (w) setTimeout(function () { URL.revokeObjectURL(blobUrl); }, 1000);
        }
        const btn = document.getElementById('btnOpenAll');
        if (btn) btn.disabled = true;
        Promise.all(items.map(function (item) {
          return fetch(item.url, { method: 'HEAD' }).then(function (res) { return { item: item, ok: res.ok }; }).catch(function () { return { item: item, ok: false }; });
        })).then(function (results) {
          const delayMs = 120;
          results.forEach(function (x, i) {
            setTimeout(function () {
              if (x.ok) {
                window.open(x.item.url, '_blank', 'noopener');
              } else {
                showNoDataPage(x.item.numStr);
              }
            }, i * delayMs);
          });
          if (btn) btn.disabled = false;
        });
      }

      function allowNumbersOnly(el) {
        el.addEventListener('input', function () {
          this.value = this.value.replace(/[^0-9]/g, '');
        });
      }
      allowNumbersOnly(document.getElementById('sessionFrom'));
      allowNumbersOnly(document.getElementById('sessionTo'));

      document.getElementById('majorItem').addEventListener('change', function () {
        updateSubItems(this.value);
        document.getElementById('subItem').value = '';
      });

      document.getElementById('btnSearch').addEventListener('click', filterData);
      document.getElementById('btnReset').addEventListener('click', () => {
        document.getElementById('majorItem').value = '';
        updateSubItems('');
        document.getElementById('subItem').value = '';
        document.getElementById('problem').value = '';
        document.getElementById('coreKeyword').value = '';
        document.getElementById('pubYear').value = '';
        document.getElementById('pubMonth').value = '';
        setSessionRangeDefaults();
        document.getElementById('period').value = '';
        document.getElementById('usage').value = '';
        filteredData = [...allData];
        renderTable(filteredData);
        updateCounts();
      });
      document.getElementById('problem').addEventListener('keydown', e => { if (e.key === 'Enter') filterData(); });
      document.getElementById('coreKeyword').addEventListener('keydown', e => { if (e.key === 'Enter') filterData(); });
      document.getElementById('btnOpenAll').addEventListener('click', openFilteredInWindows);
      document.getElementById('btnDownloadAll').addEventListener('click', () => downloadCsv(allData, 'csi_ì „ì²´.csv'));
      document.getElementById('btnDownloadFiltered').addEventListener('click', () => downloadCsv(filteredData, 'csi_ê²€ìƒ‰ê²°ê³¼.csv'));

      loadData();
    })();
  </script>
</body>
</html>
